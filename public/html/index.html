<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
</head>
<body>
<main id="wrapper">
    <header>
        <h1>Welcome to Transcriber app</h1>
        <input type="text" placeholder="Search transcript" id="searchScript">
    </header>
		<div id="intro">
			<input type="text" name="deviceName" id="userName" placeholder="please enter desired username..">
			<input type="text" name="roomName" id="roomName" placeholder="please enter room name..">
			<button id="join">Join Room</button>
		</div>
		<div id="transcriber" class="hidden">
	    <div id="content">
	    </div>
	    <div id="currentSpeech">
	    </div>
		</div>
</main>
</body>
</html>


<script src="/socket.io/socket.io.js"></script>
<script src='https://code.responsivevoice.org/responsivevoice.js'></script>
<script>

	let timeOutInterval = 0;
	let counter = 0;
	let socket = io()

	window.join.addEventListener('click', () => {
		socket.emit('join', {
			userName:window.userName.value,
			roomName:window.roomName.value
		})
	})

	socket.on('joined', () => {
		recognition.start()
		window.transcriber.classList.toggle('hidden')
		window.intro.classList.toggle('hidden')
	})

    socket.on('newUserJoined', data => {
        createMsgElement('System', new Date().getTime(), `${data.userName}: I have joined the conversation`, 1);
    })

	// var test_counter = 0;
	socket.on('speech', (data) => {
		// test_counter++;
		// console.log(test_counter,data.user , data.msg);
		// console.log(data);
		createMsgElement(data.name,data.timestamp,data.message, data.confidence);
	})

	let currentElement = window.currentSpeech

    const recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
		// recognition.lang = 'pl';

	recognition.onsoundend = function() {
	  // console.log('sound has stopped being detected');
	}

	recognition.onspeechstart = function() {
  	  // console.log('Speech has been detected');
			counter = 0;
			startCounting();

	}


	function startCounting() {
		clearTimeout(timeOutInterval);
		// console.log("timer Reset " + counter);

		counter++;
		if(counter == 3){
			// console.log("*** time UP");
			clearTimeout(timeOutInterval);
			counter = 0;
			recognition.stop();

		}else{
			timeOutInterval = setTimeout(startCounting,1000);
		}
	}


    recognition.onresult = function(event) {
    	var final_transcript = ''
    	var interim_transcript = ''
        var confidence = 0
        var newline = '\r\n'
    	for (var i = event.resultIndex; i < event.results.length; ++i) {
    	  // console.log(event.results[i][0])
	      if (event.results[i].isFinal) {
	        final_transcript += event.results[i][0].transcript;
	        confidence = event.results[i][0].confidence;
	      } else {
	        interim_transcript += event.results[i][0].transcript + ' ';
					counter = 0;
					startCounting();
	        confidence = event.results[i][0].confidence;
	      }
	    }

	    let d = new Date()

	    if (interim_transcript) {
	    	currentElement.textContent = `${interim_transcript}`
            colorfyConfidence(currentElement, confidence)
	    }

	    if (final_transcript) {
            createMsgElement(window.userName.value,d.getTime(),final_transcript, confidence);
	    	currentElement.textContent = ''
				socket.emit('message', {
					message:final_transcript,
					room:window.roomName.value,
					name: window.userName.value,
					confidence: confidence,
					timestamp: new Date().getTime()
				})
	    }
    }



function createMsgElement(user,time,msg, confidence) {
	let finalElem = document.createElement('span');
	let nl = '\r\n'
	finalElem.textContent = `${user} - ${new Date(time).toLocaleTimeString()} `
    finalElem.textContent += `Confidence: ${Math.floor(confidence * 10000) / 100}%`
    finalElem.textContent += `${nl} ${msg}`
    finalElem.style.whiteSpace = 'pre-line'
	finalElem.dataset.time = new Date(time).toLocaleTimeString();
	finalElem.dataset.speech = msg;
	finalElem.dataset.confidence = confidence
	colorfyConfidence(finalElem, confidence)
	window.content.appendChild(finalElem);
	window.content.scrollTop = window.content.scrollHeight;
}

    function colorfyConfidence(elem, confidence) {
	    var perfect = 'rgb(78, 218, 232)'
	    var best = '#bfffbf'
        var avg = '#fbf09e'
        var rubbish = '#fb9e9e'
        var finalColor = null

        if (confidence > 0.93) finalColor = perfect
        else if (confidence < 0.93 && confidence > 0.85) finalColor = best
        else if (confidence < 0.85 && confidence > 0.70) finalColor = avg
        else finalColor = rubbish

        elem.style.background = finalColor
    }

    function searchTranscript() {

    }

    recognition.onend = function(event) {
    	// console.log('finished')
    	recognition.start()
    }

    recognition.onerror = function(event) {
    	// console.log(event.error);
	};

</script>
